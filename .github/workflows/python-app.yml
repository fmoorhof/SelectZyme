# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

# todo: try miniconda 3 from here instead, think about versions and OSes https://github.com/conda-incubator/setup-miniconda#example-1-basic-usage

name: Python application

on:
  push:
    branches: ["5-pipeline-implementations"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
      
            
jobs:
  build:  # cached build is 2mins vs. 11mins
    runs-on: ubuntu-latest  # todo: change chaching path when modifying this (- name: Cache my dependencies)
    # runs-on: self-hosted
    steps:
    - uses: actions/checkout@v3

    # # check if the .yaml is valid: a bit unnecessary because actions tell you anyways if its not valid
    # - name: Validate YAML file
    #   uses: karancode/yamllint-github-action@master
    #   with:
    #       yamllint_file_or_dir: '.github/workflows/python-app.yml'
    #       yamllint_strict: false
    #       yamllint_comment: true
    #       yamllint_config_datapath: '{extends: relaxed, rules: {line-length: {max: 120}}}'
    
    - name: Setup Mambaforge
      uses: conda-incubator/setup-miniconda@v3
      with:
          miniforge-variant: Mambaforge
          miniforge-version: latest
          activate-environment: my-env
          use-mamba: true
          # environment-file: environment.yml  # define later for 'better' caching

    - name: Cache mamba environment
      id: cache
      uses: actions/cache@v3
      with:
        path: /usr/share/miniconda3/envs/my-env  # Github Actions
        # path: /home/fmoorhof/actions-runner/_work/ec/ec/3/envs/my-env  # self-hosted
        key: ${{ runner.os }}-conda-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-conda-

    - name: Update environment
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        ls /home/runner/work/ec/ec/*equiements.txt  # locate the requirements.txt file
        mamba env update -n my-env -f environment.yml
        python --version
        pip list
      
    # - name: Install dependencies
    #   if: steps.cache.outputs.cache-hit != 'true'
    #   run: |
    #     echo "source /usr/share/miniconda3/etc/profile.d/conda.sh" >> $GITHUB_ENV
    #     echo "conda activate my-env" >> $GITHUB_ENV
    #     which mamba
    #     mamba env list
    #     python --version
    #     pip list
    #     # pip install .[dev]  # install the pyproject.toml contents incl. my package 'ec'
    #     # pip install .[test]  # install the pyproject.toml contents incl. my package 'ec'
    #     pip install .
    #     pip list


  test:
    runs-on: ubuntu-latest
    # runs-on: self-hosted
    needs: build
    steps:
    - uses: actions/checkout@v3
    - uses: conda-incubator/setup-miniconda@v3
      with:
          miniforge-variant: Mambaforge
          miniforge-version: latest
          activate-environment: my-env
          use-mamba: true
          environment-file: environment.yml   

    - shell: bash -el {0}  # use activated shell, not dependent on conda init
      run: |
        conda info
        conda list
        conda config --show-sources
        conda config --show
        printenv | sort

    - shell: bash -el {0}
      run: |
          pip list
          mamba init
          mamba activate my-env
          python --version
          which python
          pip install pytest
          pip list
          python -m pytest tests/test_stack.py  # python -m needed to import correctly
          pytest tests/test_embed.py


  test2:
    runs-on: ubuntu-latest
    # runs-on: self-hosted
    needs: build
    steps:
    - uses: actions/checkout@v3

    - name: Setup Mambaforge2
      run: |
          source /usr/share/miniconda3/etc/profile.d/conda.sh
          mamba activate my-env
          pip list

    - name: Test with pytest
      shell: bash -el {0}
      run: |
        which python
        python --version
        pip list
        python -m pytest tests/test_stack.py  # python -m needed to import correctly
        pytest tests/test_embed.py

  # style:
  #   # runs-on: ubuntu-latest
  #   runs-on: self-hosted
  #   needs: build
  #   steps:
  #   - uses: actions/checkout@v3


  #   - name: Lint with flake8
  #     shell: bash -l {0}
  #     run: |
  #       source ~/.profile  # mamba init bash would require shell restart
  #       source ~/.bashrc  # created by 'mamba init'
  #       mamba activate my-env

  #       # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
  #       # flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics        